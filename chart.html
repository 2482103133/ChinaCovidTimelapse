<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç–«æƒ…åœ°å›¾å±•ç¤º</title>
  <style>
    #myEcharts {
      width: 800px;
      height: 500px;
      border: solid 1px lightgray;
      margin: 0 auto;
    }
  </style>

  <!-- å¼•å…¥ echarts.js -->
  <script src="https://echarts.apache.org/examples/vendors/echarts/echarts.min.js?_v_=1578305236132"></script>
  <!--å¼•å…¥ä¸­å›½çš„åœ°å›¾æ•°æ®jsæ–‡ä»¶ï¼Œå¼•å…¥åä¼šè‡ªåŠ¨æ³¨å†Œåœ°å›¾åå­—å’Œæ•°æ®-->
  <script src="https://echarts.apache.org/examples/vendors/echarts/map/js/china.js?_v_=1578305236132"></script>
  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.csv.min.js"></script>

</head>

<body>
  <!--ä¸ºechartså‡†å¤‡ä¸€ä¸ªdomå®¹å™¨-->
  <div id="myEcharts"></div>
  <div id="date"></div>
  <button id="replay" style="
  padding: 0;
  border: 0;
  margin: 0 auto;
">ğŸ”„é‡æ–°æ’­æ”¾</div>
    <script>
      // æŒ‡å®šå›¾è¡¨çš„é…ç½®é¡¹å’Œæ•°æ®
      option = {
        title: {
          text: 'ä¸­å›½ç–«æƒ…å›¾',
          left: 'center'
        },
        tooltip: {
          trigger: 'item'
        },
        legend: {
          orient: 'vertical',
          left: 'left',
          data: ['ä¸­å›½ç–«æƒ…å›¾']
        },
        visualMap: {
          type: 'piecewise',
          pieces: [{
              min: 10000,
              max: 1000000,
              label: 'å¤§äºç­‰äº10000äºº',
              color: '#372a28'
            },
            {
              min: 500,
              max: 9999,
              label: 'ç¡®è¯Š500-9999äºº',
              color: '#4e160f'
            },
            {
              min: 100,
              max: 499,
              label: 'ç¡®è¯Š100-499äºº',
              color: '#974236'
            },
            {
              min: 10,
              max: 99,
              label: 'ç¡®è¯Š10-99äºº',
              color: '#ee7263'
            },
            {
              min: 1,
              max: 9,
              label: 'ç¡®è¯Š1-9äºº',
              color: '#f5bba7'
            },
          ],
          color: ['#E0022B', '#E09107', '#A3E00B']
        },
        toolbox: {
          show: true,
          orient: 'vertical',
          left: 'right',
          top: 'center',
          feature: {
            mark: {
              show: true
            },
            dataView: {
              show: true,
              readOnly: false
            },
            restore: {
              show: true
            },
            saveAsImage: {
              show: true
            }
          }
        },
        roamController: {
          show: true,
          left: 'right',
          mapTypeControl: {

            'china': true
          }
        },
        series: [{
          name: 'ç¡®è¯Šæ•°',
          type: 'map',
          mapType: 'china',
          roam: false,
          label: {
            show: true,
            color: 'rgb(249, 249, 249)'
          }
        }]
      };
      //coloræ–‡ä»¶æ•°æ®
      g_color = null
      //ç–«æƒ…æ–‡ä»¶æ•°æ®
      g_csv = null
      //ç–«æƒ…æ•°æ®dataå½¢å¼ç¼“å­˜
      g_params = []
      //å½“å‰æ’­æ”¾çš„ç–«æƒ…çŠ¶æ€æŒ‡é’ˆ
      cur = 0
      //å¸§æ•°ä¹‹é—´é—´éš”
      tpf = 200
      //to-doè‰²å½©ä¹‹é—´transitionçš„æ¬¡æ•°
      tra_times = 10

      //åŠ è½½æ•°æ®å’Œè‰²å½©æ–‡ä»¶å¹¶è®¡ç®—å‡ºEchars Mapçš„data
      function do_preload() {
        colors = [...new Set(g_color.split(/\s+/))]
        len = colors.length
        piece = Math.ceil(10000 / len)
        pieces = []
        for (let i = 0; i < len; i++) {
          color = colors[i]
          pieces.push({
            min: i * piece + 1,
            max: (i + 1) * piece,
            label: 'äººæ•°' + i * piece + '~' + (i + 1) * piece + 'äºº',
            color: color
          })
        }

        pieces.push({
          min: 10000,
          max: 1000000,
          label: 'å¤§äºç­‰äº10000äºº',
          color: '#000000'
        })

        option.visualMap.pieces = pieces


        //  document.write(csv)
        // document.write(csv.substr(0, 100))
        let data = $.csv.toObjects(g_csv)
        let sorted_data = {}

        for (const element of data) {
          let date = new Date(element.updateTime)
          let str = date.toISOString()
          let key = date.toISOString().substr(0, str.indexOf('T'))
          if (element.countryName == 'ä¸­å›½' && (element.cityName != '' || element.provinceName == 'å°æ¹¾')) {
            if (sorted_data[key] === undefined) {
              sorted_data[key] = {}
            }
            var province_key = element.provinceName
            if (sorted_data[key][province_key] === undefined) {
              sorted_data[key][province_key] = {}
            }
            if (sorted_data[key][province_key][element.cityName] === undefined || Date.parse(sorted_data[key][
                province_key
              ][element.cityName].updateTime) < Date.parse(element.updateTime)) {
              sorted_data[key][province_key][element.cityName] = element
            }
            // sorted_data[key][province_key]["cases_count"]+=(parseInt(element.city_confirmedCount)-parseInt(element.city_curedCount)-parseInt(element.city_deadCount))
            // sorted_data[key][province_key]["cities"].push(element)
          }
        }

        time = 0
        for (const key of Object.keys(sorted_data).sort()) {
          var temp_data = []

          for (const province in sorted_data[key]) {
            if (sorted_data[key].hasOwnProperty(province)) {
              const element = sorted_data[key][province];
              let edited = province;
              edited = edited.replace("çœ", '')
              edited = edited.replace("å¸‚", '')
              cases_count = 0
              for (const cityName in sorted_data[key][province]) {
                if (sorted_data[key][province].hasOwnProperty(cityName)) {
                  const city = sorted_data[key][province][cityName];
                  if (city.provinceName == 'å°æ¹¾')
                    cases_count += (parseInt(city.province_confirmedCount) - parseInt(city.province_curedCount) -
                      parseInt(city.province_deadCount))
                  else
                    cases_count += (parseInt(city.city_confirmedCount) - parseInt(city.city_curedCount) - parseInt(city
                      .city_deadCount))


                }
              }

              temp_data.push({
                name: edited,
                value: cases_count
              });

            }
          }
          let opt = Object.assign({}, option)
          opt.series = [{
            name: 'ç¡®è¯Šæ•°',
            type: 'map',
            mapType: 'china',
            roam: false,
            label: {
              show: true,
              color: 'rgb(249, 249, 249)'
            },
            data: temp_data
          }]

          g_params.push({
            date: key,
            opt: opt
          })

        }


      }
      
      //ä»å½“å‰ä½ç½®å¼€å§‹æ’­æ”¾timelapse
      function do_timelapse() {
        param = g_params[cur]
        if (param === undefined)
          return
        cur++

        $("#myEcharts").empty()
        $("#myEcharts").attr("_echarts_instance_", null)
        // _echarts_instance_
        //åˆå§‹åŒ–echartså®ä¾‹
        var myChart = echarts.init(document.getElementById('myEcharts'));

        myChart.setOption(param.opt);
        $("#date").text(param.date)

        setTimeout(() => {
          do_timelapse()
        }, tpf)
      }
      //ä»å¤´æ’­æ”¾timelapse
      function do_render() {
        cur = 0
        do_timelapse()
      }

      function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
          r: parseInt(result[1], 16),
          g: parseInt(result[2], 16),
          b: parseInt(result[3], 16)
        } : null;
      }

      $(document).ready(function () {
        //é‡æ”¾
        $("#replay").click(function () {
          do_render()
        })
        //ç¼“å­˜è‰²å½©æ•°æ®
        $.get("color_path/test", function (color) {
          g_color = color
        })
        //ç¼“å­˜ä¸­å›½åœ°åŒºç–«æƒ…æ•°æ®
        $.get("data/DXYArea_China.csv", function (csv) {
          g_csv = csv
          do_preload()
          do_render()
        })
      });

    </script>
</body>

</html>